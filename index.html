<html>
<head>
    <title>FCON losses in Branch</title>
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <style>
		.progressBarText{
			font-weight: 700;
			font-size: 12px;
			line-height: 20px;
		}
		.attacker{
			display:none;
		}
        .isk {
            color: goldenrod;
            font-weight: bold;
        }

        #iskWorking {
            font-weight: normal;
            font-size: 14px;
        }

        #Results {
            display: none;
        }

        body {
            padding: 24px;
        }

        .dateField {
            color: black;
        }

        #logo {
            margin-right: 8px;
        }

        .progress {
            position: relative;
			text-align: center;
        }

            .progress span {
                position: absolute;
                display: block;
                width: 100%;
                color: black;
            }

        #highscoreHeader {
            /*background-color: lightslategray;*/
            color: black;
            font-weight: bold;
            font-size: 24px;
            padding: 6px;
            text-align:center;
        }

        .pos {
            width: 32px;
            text-align: center;
            font-weight: bold;
            display: inline-block;
            margin-right: 8px;
        }

            .pos img {
                width: 24px;
                height: 24px;
            }

        #highscoreTable {
            width: 100%;
        }

            #highscoreTable tr {
                width: 100%;
            }

            #highscoreTable td {
                
            }
            table td, table th{
                border: 0 !important;
            }
    </style>
</head>
<body>
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script>

        var Corps = [];
        var weekTotal = 0;
        
        function getWeekNumber(d) {
            // Copy date so don't modify original
            d = new Date(+d);
            d.setHours(0,0,0);
            // Set to nearest Thursday: current date + 4 - current day number
            // Make Sunday's day number 7
            d.setDate(d.getDate() + 4 - (d.getDay()||7));
            // Get first day of year
            var yearStart = new Date(d.getFullYear(),0,1);
            // Calculate full weeks to nearest Thursday
            var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            // Return array of year and week number
            return weekNo;
        }

        function AddToCorp(corpName, value, id, attacker) {
			if (Corps[corpName] != undefined) {
                Corps[corpName].lost += value;
				if (attacker == true){
					Corps[corpName].lostToAttacker += value;
				}
            }
            else {
                var corp = {
                    lost: value,
                    name: corpName,
					id: id,
					lostToAttacker: 0
                };
				if (attacker == true){
					corp.lostToAttacker += value;
				}
                Corps[corpName] = corp;
            }
        }

        function GetTotal(startTime, endTime, totalControl, attackerName, attackerControl, percentageControl,callback) {
            var urlString = "https://zkillboard.com/api/losses/regionID/10000055/allianceID/1006830534/startTime/" +
				startTime + "/endTime/" + endTime + "/no-items/";

			if (attackerName.length == 0){
				urlString += "no-attackers/";
			}

            $.get(urlString, function (data) {
                var total = 0;
				var attackerTotal = 0;
                for (var idx = 0; idx < data.length; idx++) {
                    total += data[idx].zkb.totalValue;
					if (attackerName.length > 1){
						// look for attacker name
						var km = data[idx];
						for (var ii = 0; ii < km.attackers.length; ii++){
							if (km.attackers[ii].characterName.toUpperCase() == attackerName){
								attackerTotal += km.zkb.totalValue;
							}
						}
					}
                }
                totalControl.html(total.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,'));
				attackerControl.html(attackerTotal.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,'));
				percentageControl.html((attackerTotal / total * 100).toFixed(1));
                callback();
            });
        }

        function Sort(array) {
            var trueArray = [];
            for (var key in array) {
                var newCorp = {
                    name: array[key].name,
                    lost: array[key].lost,
					id: array[key].id,
					lostToAttacker: array[key].lostToAttacker
                };

                trueArray.push(
					newCorp
				)
            }
            trueArray.sort(function (a, b) {
                a = a.lost;
                b = b.lost;

                return a > b ? -1 : (a < b ? 1 : 0);
            });

            return trueArray;
        }

        function UpdateCorpStats() {
            var corpArray = Sort(Corps);
            var highest = corpArray[0].lost;

            for (var idx = 0; idx < corpArray.length; idx++) {
                var corp = corpArray[idx];
                AddCorpLineTable(corp.name, corp.lost / highest * 100, corp.lostToAttacker / highest * 100 ,corp.lost, idx, corp.id);
            }
        }

        function AddCorpLineTable(corpname, percentage, attackerPercentage, lost, idx, corpId) {
            var html = "<tr><td class=\"pos\">";
            if (idx < 3) {
                html += "<img src=\"" + (parseInt(idx) + 1) + ".png\" />";
            }
            else {
                html += (parseInt(idx) + 1);
            }
            html += "</td><td style=\"width:0%; white-space: nowrap;\"><a target=\"_blank\" href=\"https://zkillboard.com/corporation/" + corpId +
			 	"/region/10000055/\">" + corpname + "</a></td><td style=\"width:100%\">";
            html += "<div class=\"progress\">"
			html += "<span class=\"progressBarText\">ISK " + lost.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,') + "</span>";
			
			if (attackerPercentage > 0){
				percentage -= attackerPercentage;
				html += "<div class=\"progress-bar progress-bar-warning\" role=\"progressbar\" style=\"width: " + attackerPercentage + 
				"%;\"></div>";
			}
			
			html += "<div class=\"progress-bar progress-bar-info\" role=\"progressbar\" style=\"width: " + percentage + 
				"%;\"></div>" +
				
				"</div></td></tr>";
            $("#highscoreTable").append(html);
        }


        function GetTotalForWeek(week, pagenum, control, total, attackerControl, attackerName, attackerTotal) {
            var d = new Date();
            var urlString = "https://zkillboard.com/api/losses/regionID/10000055/allianceID/1006830534/week/" + week + "/page/" + pagenum + "/no-items/";
			if (attackerName.length == 0){
				urlString += "no-attackers/";
			}
            var carryOn = true;
            var nextPage = pagenum + 1;

            $.get(urlString, function (data) {
                for (var idx = 0; idx < data.length; idx++) {
                    d = new Date(data[idx].killTime);
                    if (getWeekNumber(d) == week) {
                        total += data[idx].zkb.totalValue;
						var attackerContributed = false;
						if ((attackerName != undefined) && (attackerName.length > 1)){
							// check if attacker was part of it.
							var km = data[idx];
							for (var ii = 0; ii < km.attackers.length; ii++){
								if (km.attackers[ii].characterName.toUpperCase() == attackerName){
									attackerTotal += km.zkb.totalValue;
									attackerContributed = true;
								}
							}
						}
                        AddToCorp(data[idx].victim.corporationName, data[idx].zkb.totalValue, 
							data[idx].victim.corporationID, attackerContributed);
                        control.html(total.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,'));
						attackerControl.html(attackerTotal.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,'));
                    }
                    else {
                        control.html(total.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,'));
						attackerControl.html(attackerTotal.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,'));
						$("#attackerPercentageWeek").text((attackerTotal / total * 100).toFixed(1));
                        weekTotal = total;
                        carryOn = false;
                    }
                }
                if (carryOn) {
                    GetTotalForWeek(week, nextPage, control, total, attackerControl, attackerName, attackerTotal);
                }
                else {
                    UpdateCorpStats();
                }
            });
        }

        function GetTimeLimit(date) {
            var StartTime = date.getUTCFullYear() +
							(((date.getUTCMonth() + 1) < 10) ? "0" : "") + (date.getUTCMonth() + 1) +
							((date.getUTCDate() < 10) ? "0" : "") + date.getUTCDate();
            var Time = {
                End: StartTime + "2359",
                Start: StartTime + "0000"
            };
            return Time;
        }
		
		function getParameterByName(name) {
		    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
		    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
		        results = regex.exec(location.search);
		    return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
		}

        $(function () {
			var attackerName = getParameterByName("attacker");
			$(".attackerName").text(attackerName);
			attackerName = attackerName.toLocaleUpperCase();
            var d = new Date();
            var weekNo = getWeekNumber(d);
            $("#weekNo").text(weekNo);
            $("#todayDate").text(d.toDateString());
            var today = GetTimeLimit(d);
            d.setDate(d.getDate() - 1);
            $("#yesterdayDate").text(d.toDateString());
            var yesterday = GetTimeLimit(d);

            GetTotal(today.Start, today.End, $("#iskValueToday"), attackerName, $("#iskValueTodayAttacker"), $("#attackerPercentageToday"),function () {
                GetTotal(yesterday.Start, yesterday.End, $("#iskValueYesterday"), attackerName, $("#attackerPercentageYesterday"), $("#iskValueYesterdayAttacker"), function () {
                    $("#Working").hide();
                    $("#Results").show();
					if (attackerName != undefined && attackerName.length > 1){
						$(".attacker").show();
					}
                    GetTotalForWeek(weekNo, 1, $("#iskValueWeek"), 0, $("#iskValueWeekAttacker"), attackerName, 0);
                });
            });
        });

    </script>
    <div id="Working">
        <img src="ajax-loader.gif" /> Fetching data..
    </div>
    <div id="Results" class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title"> <span class="glyphicon glyphicon-home" aria-hidden="true"></span> FCON losses in Branch</h3>
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-xs-4 col-md-2 text-right"><h3>Today:</h3></div>
                <div class="col-xs-8"><h3 class="isk">ISK <span id="iskValueToday"></span></h3></div>
            </div>
			<div class="attacker">
				<div class="row">
	                <div class="col-xs-4 col-md-2 text-right"><h3><small><span class="attackerName"></span>:</small></h3></div>
	                <div class="col-xs-8"><h3 class="isk"><small><b>ISK <span id="iskValueTodayAttacker"></span></b>
					(<span id="attackerPercentageToday"></span>%)</small></h3></div>
	            </div>
			</div>
            <div class="row">
                <div class="col-xs-4 col-md-2 text-right"><h3>Yesterday:</h3></div>
                <div class="col-xs-8"><h3 class="isk">ISK <span id="iskValueYesterday"></span></h3></div>
            </div>
			<div class="attacker">
				<div class="row">
	                <div class="col-xs-4 col-md-2 text-right"><h3><small><span class="attackerName"></span>:</small></h3></div>
	                <div class="col-xs-8"><h3 class="isk"><small><b>ISK <span id="iskValueYesterdayAttacker"></span></b>
					(<span id="attackerPercentageYesterday"></span>%)</small></h3></div>
	            </div>
			</div>
            <div class="row">
                <div class="col-xs-4 col-md-2 text-right"><h3>This week:</h3></div>
                <div class="col-xs-8"><h3 class="isk">ISK <span id="iskValueWeek"></span></h3></div>
            </div>
			<div class="attacker">
				<div class="row">
	                <div class="col-xs-4 col-md-2 text-right"><h3><small><span class="attackerName"></span>:</small></h3></div>
	                <div class="col-xs-8"><h3 class="isk"><small><b>ISK <span id="iskValueWeekAttacker"></span></b>
					(<span id="attackerPercentageWeek"></span>%)</small></h3></div>
	            </div>
			</div>
            <div class="row">
                <div class="col-xs-12">
                    <div id="highscoreHeader">
                        Week <span id="weekNo"></span> highscore
                    </div>
                    <div id="stats" class="well">
                        <table id="highscoreTable" class="table table-condensed"></table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div>
        Powered by <a href="https://zkillboard.com/region/10000055/"><b>zKillboard</b></a>
    </div>
</body>
</html>